<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{payment/layout/base :: layout(~{::title}, ~{::div.transaction-view-content})}">
<head>
    <title th:text="'Transaction ' + ${transaction.transactionNumber}">Transaction Details</title>
</head>
<body>
<div class="transaction-view-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="fas fa-receipt me-2"></i>
            Transaction <span th:text="${transaction.transactionNumber}" class="text-primary">TXN-2025-0001</span>
        </h1>
        <div>
            <a th:href="@{/payment/transactions/{id}/edit(id=${transaction.id})}" class="btn btn-warning me-2">
                <i class="fas fa-edit me-2"></i>Edit
            </a>
            <a href="/payment/transactions" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Transactions
            </a>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        <span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>
        <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="row">
        <div class="col-md-8">
            <!-- Transaction Details Card -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Transaction Information</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong><i class="fas fa-hashtag me-2"></i>Transaction Number:</strong>
                            <span class="ms-2 badge bg-dark" th:text="${transaction.transactionNumber}">TXN-2025-0001</span>
                        </div>
                        <div class="col-md-6">
                            <strong><i class="fas fa-money-bill-wave me-2"></i>Amount:</strong>
                            <span class="ms-2 fw-bold text-success fs-5">Rs. <span th:text="${transaction.amount != null ? #numbers.formatDecimal(transaction.amount, 1, 2) : '0.00'}"></span></span>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong><i class="fas fa-flag me-2"></i>Status:</strong>
                            <span class="badge ms-2"
                                  th:classappend="${transaction.status.name() == 'PENDING'} ? 'bg-warning' : 
                                                 (${transaction.status.name() == 'VERIFIED'} ? 'bg-success' : 
                                                 (${transaction.status.name() == 'REJECTED'} ? 'bg-danger' :
                                                 (${transaction.status.name() == 'ESCALATED'} ? 'bg-info' : 'bg-secondary')))"
                                  th:text="${transaction.status}"></span>
                        </div>
                        <div class="col-md-6">
                            <strong><i class="fas fa-check-circle me-2"></i>Verification:</strong>
                            <span th:if="${transaction.verified}" class="badge bg-success ms-2">
                                <i class="fas fa-check me-1"></i>Verified
                            </span>
                            <span th:unless="${transaction.verified}" class="badge bg-secondary ms-2">
                                <i class="fas fa-clock me-1"></i>Pending
                            </span>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong><i class="fas fa-folder me-2"></i>Category:</strong>
                            <span th:if="${transaction.category != null}" th:text="${transaction.category.name}" class="ms-2 badge bg-secondary"></span>
                            <span th:unless="${transaction.category != null}" class="text-muted ms-2">-</span>
                        </div>
                        <div class="col-md-6">
                            <strong><i class="fas fa-credit-card me-2"></i>Payment Method:</strong>
                            <span th:if="${transaction.paymentMethod != null}" th:text="${transaction.paymentMethod}" class="ms-2 badge bg-info"></span>
                            <span th:unless="${transaction.paymentMethod != null}" class="text-muted ms-2">-</span>
                        </div>
                    </div>

                    <div class="row mb-3" th:if="${transaction.referenceNumber != null}">
                        <div class="col-md-12">
                            <strong><i class="fas fa-barcode me-2"></i>Reference Number:</strong>
                            <code class="ms-2 bg-light p-2 rounded" th:text="${transaction.referenceNumber}"></code>
                        </div>
                    </div>

                    <div class="row mb-3" th:if="${transaction.description != null && !transaction.description.isEmpty()}">
                        <div class="col-md-12">
                            <strong><i class="fas fa-comment me-2"></i>Description:</strong>
                            <p class="mt-2 bg-light p-3 rounded" th:text="${transaction.description}"></p>
                        </div>
                    </div>

                    <div class="row mb-3" th:if="${transaction.attachmentFilename != null}">
                        <div class="col-md-12">
                            <strong><i class="fas fa-paperclip me-2"></i>Attachment:</strong>
                            <div class="mt-2">
                                <span class="badge bg-primary me-2"><i class="fas fa-file me-1"></i>Attachment Available</span>
                                <small class="text-muted" th:text="${transaction.attachmentFilename}"></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Student Information Card -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-user-graduate me-2"></i>Student Information</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <strong><i class="fas fa-user me-2"></i>Name:</strong>
                            <span class="ms-2" th:text="${transaction.studentName}"></span>
                        </div>
                        <div class="col-md-6">
                            <strong><i class="fas fa-id-card me-2"></i>Student ID:</strong>
                            <span class="ms-2" th:text="${transaction.studentId}"></span>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <strong><i class="fas fa-envelope me-2"></i>Email:</strong>
                            <a th:href="'mailto:' + ${transaction.studentEmail}" class="ms-2" th:text="${transaction.studentEmail}"></a>
                        </div>
                        <div class="col-md-6" th:if="${transaction.studentPhone != null}">
                            <strong><i class="fas fa-phone me-2"></i>Phone:</strong>
                            <a th:href="'tel:' + ${transaction.studentPhone}" class="ms-2" th:text="${transaction.studentPhone}"></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Actions Card -->
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <h6 class="mb-0"><i class="fas fa-tasks me-2"></i>Actions</h6>
                </div>
                <div class="card-body">
                    <!-- Verify/Reject Buttons -->
                    <div th:if="${!transaction.verified}" class="d-grid gap-2 mb-3">
                        <form th:action="@{/payment/transactions/{id}/verify(id=${transaction.id})}" method="post" class="d-inline">
                            <input type="hidden" name="verified" value="true" />
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-check-circle me-2"></i>Verify Payment
                            </button>
                        </form>
                        <form th:action="@{/payment/transactions/{id}/verify(id=${transaction.id})}" method="post" class="d-inline">
                            <input type="hidden" name="verified" value="false" />
                            <button type="submit" class="btn btn-danger w-100">
                                <i class="fas fa-times-circle me-2"></i>Reject Payment
                            </button>
                        </form>
                    </div>

                    <!-- Status Update -->
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Update Status:</label>
                        <form th:action="@{/payment/transactions/{id}/status(id=${transaction.id})}" method="post">
                            <select name="status" class="form-select form-select-sm mb-2">
                                <option value="PENDING" th:selected="${transaction.status.name() == 'PENDING'}">Pending</option>
                                <option value="VERIFIED" th:selected="${transaction.status.name() == 'VERIFIED'}">Verified</option>
                                <option value="REJECTED" th:selected="${transaction.status.name() == 'REJECTED'}">Rejected</option>
                                <option value="ESCALATED" th:selected="${transaction.status.name() == 'ESCALATED'}">Escalated</option>
                                <option value="COMPLETED" th:selected="${transaction.status.name() == 'COMPLETED'}">Completed</option>
                            </select>
                            <button type="submit" class="btn btn-sm btn-primary w-100">
                                <i class="fas fa-save me-1"></i>Update Status
                            </button>
                        </form>
                    </div>

                    <!-- Delete Button -->
                    <div class="d-grid">
                        <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal">
                            <i class="fas fa-trash me-2"></i>Delete Transaction
                        </button>
                    </div>
                </div>
            </div>

            <!-- Transaction Metadata Card -->
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="fas fa-clock me-2"></i>Transaction History</h6>
                </div>
                <div class="card-body small">
                    <div class="mb-2">
                        <strong><i class="fas fa-calendar-plus me-1"></i>Created:</strong>
                        <div class="text-muted" th:text="${transaction.createdAt != null ? #temporals.format(transaction.createdAt, 'MMM dd, yyyy HH:mm') : '-'}"></div>
                    </div>
                    <div class="mb-2">
                        <strong><i class="fas fa-calendar-check me-1"></i>Last Updated:</strong>
                        <div class="text-muted" th:text="${transaction.updatedAt != null ? #temporals.format(transaction.updatedAt, 'MMM dd, yyyy HH:mm') : '-'}"></div>
                    </div>
                    <div class="mb-2" th:if="${transaction.verifiedAt != null}">
                        <strong><i class="fas fa-check-double me-1"></i>Verified At:</strong>
                        <div class="text-muted" th:text="${#temporals.format(transaction.verifiedAt, 'MMM dd, yyyy HH:mm')}"></div>
                    </div>
                    <div class="mb-2" th:if="${transaction.verifiedBy != null}">
                        <strong><i class="fas fa-user-check me-1"></i>Verified By:</strong>
                        <div class="text-muted" th:text="${transaction.verifiedBy}"></div>
                    </div>
                    <div th:if="${transaction.lastModifiedBy != null}">
                        <strong><i class="fas fa-user-edit me-1"></i>Last Modified By:</strong>
                        <div class="text-muted" th:text="${transaction.lastModifiedBy}"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>Delete Transaction
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form th:action="@{/payment/transactions/{id}/delete(id=${transaction.id})}" method="post">
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <strong>Warning!</strong> This action cannot be undone.
                        </div>
                        <p>Are you sure you want to delete this transaction?</p>
                        <div class="card">
                            <div class="card-body bg-light">
                                <strong>Transaction:</strong> <span th:text="${transaction.transactionNumber}"></span><br>
                                <strong>Student:</strong> <span th:text="${transaction.studentName}"></span><br>
                                <strong>Amount:</strong> Rs. <span th:text="${#numbers.formatDecimal(transaction.amount, 1, 2)}"></span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash me-2"></i>Delete
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
</body>
</html>
