<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
      layout:decorate="~{layout}">
<head>
    <title>All Tickets - Help Desk System</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">
                <i class="fas fa-ticket-alt me-2"></i>All Tickets
            </h1>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="get" action="/admin/tickets">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="search" class="form-label">Search</label>
                            <input type="text" class="form-control" id="search" name="search" 
                                   th:value="${search}" placeholder="Search tickets...">
                        </div>
                        <div class="col-md-2">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="">All Statuses</option>
                                <option th:each="s : ${statuses}" th:value="${s}" 
                                        th:text="${s}" th:selected="${s.toString() == status}"></option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="priority" class="form-label">Priority</label>
                            <select class="form-select" id="priority" name="priority">
                                <option value="">All Priorities</option>
                                <option th:each="p : ${priorities}" th:value="${p}" 
                                        th:text="${p}" th:selected="${p.toString() == priority}"></option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="categoryId" class="form-label">Category</label>
                            <select class="form-select" id="categoryId" name="categoryId">
                                <option value="">All Categories</option>
                                <option th:each="cat : ${categories}" th:value="${cat.id}" 
                                        th:text="${cat.name}" th:selected="${cat.id == categoryId}"></option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search me-2"></i>Filter
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tickets Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Tickets List
                    <span class="badge bg-primary ms-2" th:text="${tickets.totalElements}">0</span>
                </h5>
            </div>
            <div class="card-body">
                <div th:if="${tickets.empty}" class="text-center py-5">
                    <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No tickets found</h5>
                    <p class="text-muted">No tickets match your search criteria.</p>
                </div>
                
                <div th:if="${!tickets.empty}">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Student</th>
                                    <th>Category</th>
                                    <th>Priority</th>
                                    <th>Status</th>
                                    <th>Assigned To</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="ticket : ${tickets.content}">
                                    <td>
                                        <span class="fw-bold text-primary" th:text="'#' + ${ticket.id}">#001</span>
                                    </td>
                                    <td>
                                        <a th:href="@{/tickets/{id}(id=${ticket.id})}" 
                                           class="text-decoration-none fw-bold" 
                                           th:text="${ticket.title}">Ticket Title</a>
                                        <div class="text-muted small" th:text="${#strings.abbreviate(ticket.description, 40)}">
                                            Short description...
                                        </div>
                                    </td>
                                    <td>
                                        <span th:text="${ticket.user != null ? ticket.user.fullName : 'N/A'}">Student Name</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary" th:text="${ticket.category != null ? ticket.category.name : 'N/A'}">Category</span>
                                    </td>
                                    <td>
                                        <span class="badge" 
                                              th:classappend="${'priority-' + #strings.toLowerCase(ticket.priority)}"
                                              th:text="${ticket.priority}">Priority</span>
                                    </td>
                                    <td>
                                        <span class="badge" 
                                              th:classappend="${'status-' + #strings.toLowerCase(#strings.replace(ticket.status, '_', '-'))}"
                                              th:text="${#strings.replace(ticket.status, '_', ' ')}">Status</span>
                                    </td>
                                    <td>
                                        <span th:if="${ticket.assignedTo != null}" th:text="${ticket.assignedTo.fullName}">Staff Name</span>
                                        <span th:if="${ticket.assignedTo == null}" class="text-muted">Unassigned</span>
                                    </td>
                                    <td>
                                        <span th:text="${#temporals.format(ticket.createdAt, 'MMM dd, yyyy')}">Date</span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a th:href="@{/tickets/{id}(id=${ticket.id})}"
                                               class="btn btn-outline-primary" title="View">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a th:href="@{/admin/tickets/{id}/edit(id=${ticket.id})}"
                                               class="btn btn-outline-warning" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-outline-info"
                                                    data-bs-toggle="modal"
                                                    th:data-bs-target="'#assignModal' + ${ticket.id}"
                                                    title="Assign">
                                                <i class="fas fa-user-plus"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-danger"
                                                    data-bs-toggle="modal"
                                                    th:data-bs-target="'#deleteModal' + ${ticket.id}"
                                                    title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <nav th:if="${tickets.totalPages > 1}">
                        <ul class="pagination justify-content-center">
                            <li class="page-item" th:classappend="${tickets.first} ? 'disabled'">
                                <a class="page-link" th:href="@{/admin/tickets(page=${currentPage - 1}, search=${search}, status=${status}, priority=${priority}, categoryId=${categoryId})}">
                                    Previous
                                </a>
                            </li>
                            <li class="page-item" th:each="i : ${#numbers.sequence(0, tickets.totalPages - 1)}"
                                th:classappend="${i == currentPage} ? 'active'">
                                <a class="page-link" th:href="@{/admin/tickets(page=${i}, search=${search}, status=${status}, priority=${priority}, categoryId=${categoryId})}"
                                   th:text="${i + 1}">1</a>
                            </li>
                            <li class="page-item" th:classappend="${tickets.last} ? 'disabled'">
                                <a class="page-link" th:href="@{/admin/tickets(page=${currentPage + 1}, search=${search}, status=${status}, priority=${priority}, categoryId=${categoryId})}">
                                    Next
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Assign Modal for each ticket -->
        <div th:each="ticket : ${tickets.content}">
            <div class="modal fade" th:id="'assignModal' + ${ticket.id}" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Assign Ticket #<span th:text="${ticket.id}">1</span></h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <form th:action="@{/admin/tickets/{id}/assign(id=${ticket.id})}" method="post">
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="staffId" class="form-label">Assign to Staff Member</label>
                                    <select class="form-select" name="staffId" id="staffId" required>
                                        <option value="">Select Staff Member</option>
                                        <option th:each="staff : ${staffUsers}"
                                                th:value="${staff.id}"
                                                th:text="${staff.fullName}"
                                                th:selected="${ticket.assignedTo != null && ticket.assignedTo.id == staff.id}">
                                            Staff Name
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">Assign</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal for each ticket -->
        <div th:each="ticket : ${tickets.content}">
            <div class="modal fade" th:id="'deleteModal' + ${ticket.id}" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-exclamation-triangle me-2"></i>Delete Ticket #<span th:text="${ticket.id}">1</span>
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <form th:action="@{/admin/tickets/{id}/delete(id=${ticket.id})}" method="post">
                            <div class="modal-body">
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-circle me-2"></i>
                                    <strong>Warning!</strong> This action cannot be undone.
                                </div>
                                <p>Are you sure you want to delete this ticket?</p>
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title" th:text="${ticket.title}">Ticket Title</h6>
                                        <p class="card-text small text-muted mb-1">
                                            <strong>Student:</strong> <span th:text="${ticket.user != null ? ticket.user.fullName : 'N/A'}">Student Name</span>
                                        </p>
                                        <p class="card-text small text-muted mb-1">
                                            <strong>Category:</strong> <span th:text="${ticket.category != null ? ticket.category.name : 'N/A'}">Category</span>
                                        </p>
                                        <p class="card-text small text-muted mb-0">
                                            <strong>Status:</strong> <span th:text="${ticket.status}">Status</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-2"></i>Cancel
                                </button>
                                <button type="submit" class="btn btn-danger">
                                    <i class="fas fa-trash me-2"></i>Delete Ticket
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

